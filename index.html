<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rebalancing App</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; line-height: 1.6; }
        .container { border: 1px solid #ddd; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .input-row { display: grid; grid-template-columns: 2fr 1fr 2fr 2fr auto; gap: 10px; align-items: center; margin-bottom: 10px; }
        .input-row input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .input-row .display-value { padding: 8px; background: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; text-align: right; }
        .input-row button { padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .add-btn { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .add-btn:hover { background: #218838; }
        .header-row { display: grid; grid-template-columns: 2fr 1fr 2fr 2fr auto; gap: 10px; font-weight: bold; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #007bff; }
        #holdings-list { margin-top: 20px; }
        .contribution-section { margin-bottom: 30px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .contribution-section label { display: block; margin-bottom: 5px; font-weight: bold; }
        .contribution-section input { padding: 10px; width: 200px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .totals-row { display: grid; grid-template-columns: 2fr 1fr 2fr 2fr auto; gap: 10px; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid #007bff; font-weight: bold; }
        .totals-row .display-value { padding: 8px; background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; text-align: right; }
    </style>
</head>
<body>

<div class="container">
    <h2>Portfolio Rebalancing Calculator</h2>
    
    <div class="contribution-section">
        <label for="contribution-amount">Contribution Amount ($):</label>
        <input type="number" id="contribution-amount" placeholder="0.00" min="0" step="0.01">
    </div>
    
    <p>Enter your holdings to calculate rebalancing targets:</p>
    
    <div id="holdings-list">
        <div class="header-row">
            <div>Ticker</div>
            <div>Target %</div>
            <div>Current Amount ($)</div>
            <div>Amount to Contribute ($)</div>
            <div></div>
        </div>
    </div>
    
    <div class="totals-row">
        <div>TOTALS</div>
        <div class="display-value" id="total-target">0.00</div>
        <div class="display-value" id="total-amount">0.00</div>
        <div class="display-value" id="total-contribute">0.00</div>
        <div></div>
    </div>
    
    <button class="add-btn" id="add-row-btn">+ Add Holding</button>
</div>

<script>
    let holdingsData = [];
    let rowCounter = 0;

    function addRow() {
        const rowId = rowCounter++;
        const rowDiv = document.createElement('div');
        rowDiv.className = 'input-row';
        rowDiv.id = `row-${rowId}`;
        
        rowDiv.innerHTML = `
            <input type="text" placeholder="e.g., VTSAX" data-field="ticker" data-row="${rowId}">
            <input type="number" placeholder="20" min="0" max="100" step="0.01" data-field="target" data-row="${rowId}">
            <input type="number" placeholder="5000" min="0" step="0.01" data-field="amount" data-row="${rowId}">
            <div class="display-value" id="calc-${rowId}">0.00</div>
            <button onclick="removeRow(${rowId})">Remove</button>
        `;
        
        document.getElementById('holdings-list').appendChild(rowDiv);
        
        holdingsData.push({
            id: rowId,
            ticker: '',
            target: 0,
            amount: 0
        });
    }

    function removeRow(rowId) {
        const rowElement = document.getElementById(`row-${rowId}`);
        if (rowElement) {
            rowElement.remove();
        }
        holdingsData = holdingsData.filter(item => item.id !== rowId);
        updateTotals();
    }

    function updateTotals() {
        let totalTarget = 0;
        let totalAmount = 0;
        let totalContribute = 0;
        
        holdingsData.forEach(holding => {
            totalTarget += holding.target || 0;
            totalAmount += holding.amount || 0;
            // Get the calculated contribution value from the display element
            const calcElement = document.getElementById(`calc-${holding.id}`);
            if (calcElement) {
                totalContribute += parseFloat(calcElement.textContent) || 0;
            }
        });
        
        document.getElementById('total-target').textContent = totalTarget.toFixed(2);
        document.getElementById('total-amount').textContent = totalAmount.toFixed(2);
        document.getElementById('total-contribute').textContent = totalContribute.toFixed(2);
    }

    document.getElementById('add-row-btn').addEventListener('click', addRow);

    // Add event listener to update holdings data when inputs change
    document.getElementById('holdings-list').addEventListener('input', (e) => {
        if (e.target.tagName === 'INPUT') {
            const rowId = parseInt(e.target.dataset.row);
            const field = e.target.dataset.field;
            const value = e.target.value;
            
            const holding = holdingsData.find(h => h.id === rowId);
            if (holding) {
                holding[field] = field === 'ticker' ? value : parseFloat(value) || 0;
                updateTotals();
            }
        }
    });

    async function initPyodide() {
        let pyodide = await loadPyodide();
        console.log("Python is ready!");
    }

    initPyodide();
    
    // Add initial row
    addRow();
</script>

</body>
</html>