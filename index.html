<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rebalancing App</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; line-height: 1.6; }
        .container { border: 1px solid #ddd; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .input-row { display: grid; grid-template-columns: 2fr 1fr 2fr 2fr auto; gap: 10px; align-items: center; margin-bottom: 10px; }
        .input-row input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .input-row .display-value { padding: 8px; background: #e9ecef; border: 1px solid #ced4da; border-radius: 4px; text-align: right; }
        .input-row button { padding: 8px 12px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .add-btn { padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        .add-btn:hover { background: #218838; }
        .calc-btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; margin-left: 10px; }
        .calc-btn:hover { background: #0056b3; }
        .calc-btn:disabled { background: #6c757d; cursor: not-allowed; }
        .header-row { display: grid; grid-template-columns: 2fr 1fr 2fr 2fr auto; gap: 10px; font-weight: bold; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #007bff; }
        #holdings-list { margin-top: 20px; }
        .contribution-section { margin-bottom: 30px; padding: 15px; background: #f8f9fa; border-radius: 5px; }
        .contribution-section label { display: block; margin-bottom: 5px; font-weight: bold; }
        .contribution-section input { padding: 10px; width: 200px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .totals-row { display: grid; grid-template-columns: 2fr 1fr 2fr 2fr auto; gap: 10px; align-items: center; margin-top: 15px; padding-top: 15px; border-top: 2px solid #007bff; font-weight: bold; }
        .totals-row .display-value { padding: 8px; background: #d1ecf1; border: 1px solid #bee5eb; border-radius: 4px; text-align: right; }
    </style>
</head>
<body>

<div class="container">
    <h2>Portfolio Rebalancing Calculator</h2>
    
    <div class="contribution-section">
        <label for="contribution-amount">Contribution Amount ($):</label>
        <input type="number" id="contribution-amount" placeholder="0.00" min="0" step="0.01">
    </div>
    
    <p>Enter your holdings to calculate rebalancing targets:</p>
    
    <div id="holdings-list">
        <div class="header-row">
            <div>Ticker</div>
            <div>Target %</div>
            <div>Current Amount ($)</div>
            <div>Amount to Contribute ($)</div>
            <div></div>
        </div>
    </div>
    
    <div class="totals-row">
        <div>TOTALS</div>
        <div class="display-value" id="total-target">0.00</div>
        <div class="display-value" id="total-amount">0.00</div>
        <div class="display-value" id="total-contribute">0.00</div>
        <div></div>
    </div>
    
    <button class="add-btn" id="add-row-btn">+ Add Holding</button>
    <button class="calc-btn" id="calc-btn">Calculate</button>
</div>

<script>
    let holdingsData = [];
    let rowCounter = 0;
    let pyodide = null;

    function addRow() {
        const rowId = rowCounter++;
        const rowDiv = document.createElement('div');
        rowDiv.className = 'input-row';
        rowDiv.id = `row-${rowId}`;
        
        rowDiv.innerHTML = `
            <input type="text" placeholder="e.g., VTSAX" data-field="ticker" data-row="${rowId}">
            <input type="number" placeholder="20" min="0" max="100" step="0.01" data-field="target" data-row="${rowId}">
            <input type="number" placeholder="5000" min="0" step="0.01" data-field="amount" data-row="${rowId}">
            <div class="display-value" id="calc-${rowId}">0.00</div>
            <button onclick="removeRow(${rowId})">Remove</button>
        `;
        
        document.getElementById('holdings-list').appendChild(rowDiv);
        
        holdingsData.push({
            id: rowId,
            ticker: '',
            target: 0,
            amount: 0
        });
    }

    function removeRow(rowId) {
        const rowElement = document.getElementById(`row-${rowId}`);
        if (rowElement) {
            rowElement.remove();
        }
        holdingsData = holdingsData.filter(item => item.id !== rowId);
        updateTotals();
    }

    function updateTotals() {
        let totalTarget = 0;
        let totalAmount = 0;
        let totalContribute = 0;
        
        holdingsData.forEach(holding => {
            totalTarget += holding.target || 0;
            totalAmount += holding.amount || 0;
            // Get the calculated contribution value from the display element
            const calcElement = document.getElementById(`calc-${holding.id}`);
            if (calcElement) {
                totalContribute += parseFloat(calcElement.textContent) || 0;
            }
        });
        
        document.getElementById('total-target').textContent = totalTarget.toFixed(2);
        document.getElementById('total-amount').textContent = totalAmount.toFixed(2);
        document.getElementById('total-contribute').textContent = totalContribute.toFixed(2);
    }

    document.getElementById('add-row-btn').addEventListener('click', addRow);

    // Add event listener to update holdings data when inputs change
    document.getElementById('holdings-list').addEventListener('input', (e) => {
        if (e.target.tagName === 'INPUT') {
            const rowId = parseInt(e.target.dataset.row);
            const field = e.target.dataset.field;
            const value = e.target.value;
            
            const holding = holdingsData.find(h => h.id === rowId);
            if (holding) {
                holding[field] = field === 'ticker' ? value : parseFloat(value) || 0;
                updateTotals();
            }
        }
    });

    async function initPyodide() {
        pyodide = await loadPyodide();
        await pyodide.loadPackage('numpy');
        await pyodide.loadPackage('scipy');
        console.log("Python is ready!");
        document.getElementById('calc-btn').disabled = false;
    }

    async function calculate() {
        if (!pyodide) {
            console.error('Pyodide not initialized yet');
            return;
        }
        
        // Get contribution amount
        const contributionAmount = parseFloat(document.getElementById('contribution-amount').value) || 0;
        
        // Create list of dictionaries with all holding data
        const holdingsList = holdingsData.map(h => ({
            ticker: h.ticker || '',
            target_percent: h.target || 0,
            current_amount: h.amount || 0
        }));
        
        // Pass data to Python namespace
        pyodide.globals.set('contribution_amount', contributionAmount);
        pyodide.globals.set('holdings_list', holdingsList);
        
        const pythonCode = `
import numpy as np
from scipy.optimize import minimize
from dataclasses import dataclass
from typing import List

@dataclass
class Holding:
    ticker: str
    target_percentage: float
    current_holding: float

@dataclass
class Contribution:
    ticker: str
    amount_to_deposit: float

def objective(c: np.ndarray, x: np.ndarray, p: np.ndarray, T: float) -> float:
    # objective is sum of the abs diff between the projected percentage and the target percentage
    denom = (x + c * T).sum()

    j_c = np.sum(np.abs(((x + c * T) / denom) - p))

    return j_c

def new_objective(c: np.ndarray, x: np.ndarray, p: np.ndarray, T: float, debug: bool) -> float:
    projected_value_per_fund = x + c * T
    total_projected_portfolio_value = (projected_value_per_fund).sum()

    diff_between_projected_and_target = (projected_value_per_fund / total_projected_portfolio_value) - p

    underfunded_diffs = diff_between_projected_and_target[diff_between_projected_and_target <= 0]
    overfunded_diffs = diff_between_projected_and_target[diff_between_projected_and_target > 0]

    if debug:
        print("c", c)
        print("diffs", diff_between_projected_and_target)
        print("underfunded diffs", underfunded_diffs)
        print("")

    diff_between_min_and_max_underfunded = np.abs(underfunded_diffs.max() - underfunded_diffs.min())
    overfunded_penalty = np.sum(overfunded_diffs * 10)

    j_c = diff_between_min_and_max_underfunded + overfunded_penalty

    return j_c

def sum_to_1_constraint(c: np.ndarray):
    return 1.0 - c.sum()

def get_optimal_values_new(holdings: List[Holding], amount_to_deposit, debug=False) -> List[Contribution]:
    num_holdings = len(holdings)
    c_0 = np.ones(num_holdings) * (1.0 / num_holdings)

    current_values = np.array([h.current_holding for h in holdings])
    target_fractions = np.array([h.target_percentage for h in holdings]) * 1e-2

    bounds = [[0.0, 1.0] for _ in range(num_holdings)]
    constraint_params = {"type": "eq", "fun": sum_to_1_constraint}
    constraints = [constraint_params]

    solution = minimize(new_objective, c_0, args=(current_values, target_fractions, amount_to_deposit, debug), method="SLSQP", bounds=bounds, constraints=constraints)

    rounded_values = np.round(amount_to_deposit * solution.x, 2)
    if rounded_values.sum() > amount_to_deposit:
        rounded_values[0] = rounded_values[0] - (rounded_values.sum() - amount_to_deposit)
    elif rounded_values.sum() < amount_to_deposit:
        rounded_values[0] = rounded_values[0] + (amount_to_deposit - rounded_values.sum())

    return [
        Contribution(ticker=h.ticker, amount_to_deposit=float(r))
        for h, r in zip(holdings, rounded_values)
    ]

def main() -> List[Contribution]:
    # Convert JavaScript proxy to Python object
    holdings_py = holdings_list.to_py()

    holdings = [
        Holding(ticker=h['ticker'], target_percentage=h['target_percent'], current_holding=h['current_amount']) 
        for h in holdings_py
    ]

    return get_optimal_values_new(holdings, contribution_amount, debug=False)


if __name__ == "__main__":
    contributions = main()

    contributions_dicts = [{'ticker': c.ticker, 'amount_to_deposit': c.amount_to_deposit} for c in contributions]

contributions_dicts
        `;
        
        try {
            const result = await pyodide.runPythonAsync(pythonCode);
            console.log('Python result:', result);
            
            // Convert Python result to JavaScript array
            const contributions = result.toJs();
            console.log('Contributions JS:', contributions);
            
            // Update each holding's display value
            contributions.forEach(contrib => {
                const ticker = contrib.get('ticker');
                const amountToDeposit = contrib.get('amount_to_deposit');
                
                // Find the corresponding holding by ticker
                const holding = holdingsData.find(h => h.ticker === ticker);
                if (holding) {
                    // Update the display element
                    const displayElement = document.getElementById(`calc-${holding.id}`);
                    if (displayElement) {
                        displayElement.textContent = amountToDeposit.toFixed(2);
                    }
                }
            });
            
            // Update totals after updating all contributions
            updateTotals();
            
        } catch (err) {
            console.error('Python error:', err);
        }
    }

    document.getElementById('calc-btn').addEventListener('click', calculate);
    document.getElementById('calc-btn').disabled = true;

    initPyodide();
    
    // Prepopulate holdings
    const prepopulatedHoldings = {
        "VBIL": 2.0,
        "VTIP": 1.5,
        "VCIT": 1.5,
        "VOO": 7.5,
        "VTV": 15.0,
        "VB": 15.0,
        "VBR": 12.5,
        "VT": 15.75,
        "VSS": 29.25
    };
    
    // Add rows for prepopulated holdings
    Object.entries(prepopulatedHoldings).forEach(([ticker, targetPercent]) => {
        addRow();
        const lastHolding = holdingsData[holdingsData.length - 1];
        const rowId = lastHolding.id;
        
        // Update the data
        lastHolding.ticker = ticker;
        lastHolding.target = targetPercent;
        lastHolding.amount = 0;
        
        // Update the input fields
        const rowElement = document.getElementById(`row-${rowId}`);
        if (rowElement) {
            rowElement.querySelector('[data-field="ticker"]').value = ticker;
            rowElement.querySelector('[data-field="target"]').value = targetPercent;
            rowElement.querySelector('[data-field="amount"]').value = 0;
        }
    });
    
    updateTotals();
</script>

</body>
</html>